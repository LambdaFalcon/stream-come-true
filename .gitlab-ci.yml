###############################################################################
# SETTINGS

# latest LTS that works well with create-react-app
image: node:10.15.3

stages:
  - build
  - test
  - deploy

cache:
  paths:
    - server/node_modules/
    - client/node_modules/

###############################################################################
# BUILD STAGE

server_build:
  stage: build
  script:
    - npm ci --prefix ./server
    - npm run build --prefix ./server
  only:
    changes:
      - ./server/**/*

client_build:
  stage: build
  script:
    - npm ci --prefix ./client
    - npm run build --prefix ./client
  only:
    changes:
      - ./client/**/*

###############################################################################
# TEST STAGE

server_test:
  stage: test
  script:
    - npm ci --prefix ./server
    - npm test --prefix ./server
  only:
    changes:
      - ./server/**/*

client_test:
  stage: test
  script:
    - npm ci --prefix ./client
    - npm test --prefix ./client
  only:
    changes:
      - ./client/**/*

###############################################################################
# DEPLOY STAGE

server_deploy:
  stage: deploy
  script: "echo 'No deploy job yet.'"
  only:
    refs:
      - master
