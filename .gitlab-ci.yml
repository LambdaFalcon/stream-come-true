###############################################################################
# SETTINGS

# latest LTS that works well with create-react-app
image: docker:stable

services:
  - docker:dind

variables:
  NODE: node:10.15.3

stages:
  - build
  - lint
  - test
  - docker build
  - deploy

###############################################################################
# BUILD STAGE

server install:
  image: $NODE
  stage: build
  script:
    - npm ci --prefix server
  artifacts:
    paths:
      - server/node_modules/
  only:
    changes:
      - server/**/*

client build:
  image: $NODE
  stage: build
  script:
    - npm ci --prefix client
    - npm run build --prefix client
  artifacts:
    paths:
      - client/build/
      - client/node_modules/
  only:
    changes:
      - client/**/*

###############################################################################
# LINT STAGE

server lint:
  image: $NODE
  stage: lint
  script:
    - npm run lint --prefix server
  dependencies:
    - server install
  only:
    changes:
      - server/**/*

###############################################################################
# TEST STAGE

server test:
  image: $NODE
  stage: test
  script:
    - npm ci --prefix server
    - npm run cov --prefix server
  coverage: '/All files\s*\|\s*([0-9.]+)/'
  dependencies:
    - server install
    - client build
  only:
    changes:
      - server/**/*

client test:
  image: $NODE
  stage: test
  script:
    - npm test --prefix client
  dependencies:
    - client build
  only:
    changes:
      - client/**/*

###############################################################################
# DOCKER BUILD STAGE

docker build staging:
  stage: docker build
  script:
    - docker info
    - docker build -t stream-come-true:staging .
    - docker image ls
  only:
    refs:
      - dev
      - 49-implement-staging-and-deploy-stages-of-ci
    changes:
      - client/**/*
      - server/**/*

docker build release:
  stage: docker build
  script:
    - docker info
    - docker build -t stream-come-true:latest .
    - docker image ls
  only:
    refs:
      - master
    changes:
      - client/**/*
      - server/**/*

###############################################################################
# DEPLOY STAGE

docker deploy staging:
  stage: deploy
  script:
    - docker info
    - docker image ls
    - echo "$REGISTRY_PASSWORD" | docker login --username $REGISTRY_USER --password-stdin
    - docker push $REGISTRY_USER/stream-come-true:staging
    - docker
  only:
    refs:
      - dev
      - 49-implement-staging-and-deploy-stages-of-ci
    changes:
      - client/**/*
      - server/**/*

docker deploy release:
  stage: deploy
  script:
    - docker info
    - docker image ls
    - echo "$REGISTRY_PASSWORD" | docker login --username $REGISTRY_USER --password-stdin
    - docker push $REGISTRY_USER/stream-come-true:latest
  only:
    refs:
      - master
    changes:
      - client/**/*
      - server/**/*
